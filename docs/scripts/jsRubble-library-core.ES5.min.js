/*

  jsRubble Physics Engine - Minified ES5 Core Library (Minified and transpiled using Babel)

  Source repository (at time of writing):
  https://github.com/tommccracken/jsRubble


  Copyright 2017 Thomas O. McCracken

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

*/

"use strict";var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var PI=Math.PI;function deg2rad(a){return a*PI/180}function rad2deg(a){return 180*a/PI}function get_time(){return Date.now()}function time_since(a){return get_time()-a}var Vector2=function(){function a(b,c){_classCallCheck(this,a),this.x=b,this.y=c}return _createClass(a,[{key:"magnitude_squared",value:function magnitude_squared(){return this.x*this.x+this.y*this.y}},{key:"magnitude",value:function magnitude(){return Math.sqrt(this.magnitude_squared())}},{key:"unit_vector",value:function unit_vector(){return new a(this.x/this.magnitude(),this.y/this.magnitude())}},{key:"add",value:function add(b){return new a(this.x+b.x,this.y+b.y)}},{key:"add_to_this",value:function add_to_this(b){this.x+=b.x,this.y+=b.y}},{key:"subtract",value:function subtract(b){return new a(this.x-b.x,this.y-b.y)}},{key:"scale",value:function scale(b){return new a(b*this.x,b*this.y)}},{key:"scale_this",value:function scale_this(b){this.x=b*this.x,this.y=b*this.y}},{key:"set_to",value:function set_to(b){this.x=b.x,this.y=b.y}},{key:"set_to_zero",value:function set_to_zero(){this.x=0,this.y=0}},{key:"rotate_about",value:function rotate_about(b,c){var d,e;return d=b.x+(this.x-b.x)*Math.cos(c)-(this.y-b.y)*Math.sin(c),e=b.y+(this.x-b.x)*Math.sin(c)+(this.y-b.y)*Math.cos(c),new a(d,e)}},{key:"distance_from_squared",value:function distance_from_squared(b){return(b.x-this.x)*(b.x-this.x)+(b.y-this.y)*(b.y-this.y)}},{key:"distance_from",value:function distance_from(b){return Math.sqrt(this.distance_from_squared(b))}}]),a}(),AbstractWorldElement=function(){function a(){_classCallCheck(this,a),this.age=0,this.lifetime=null}return _createClass(a,[{key:"has_life_expired",value:function has_life_expired(){return null!==this.lifetime&&this.age>=this.lifetime}}]),a}(),Particle=function(a){function b(c,d,e,f,g,h,k,l,m,n,o){_classCallCheck(this,b);var p=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return p.mass=m,p.inv_mass=1/m,p.radius=n,p.fixed=o,p.pos=new Vector2(c,d),p.pos_previous=new Vector2(c,d),p.vel=new Vector2(e,f),p.acc=new Vector2(g,h),p.force=new Vector2(k,l),p.collides=!0,p.lifetime=null,p.attractive_strength=0,p.SPH_particle=!1,p.SPH_neighbours=[],p.SPH_density=0,p}return _inherits(b,a),_createClass(b,[{key:"integrate",value:function integrate(c,d){var e;this.fixed||(this.force.scale_this(this.inv_mass),this.acc.add_to_this(this.force),e=new Vector2(this.pos.x,this.pos.y),this.pos=this.pos.scale(2-d).subtract(this.pos_previous.scale(1-d)).add(this.acc.scale(c*c)),this.vel=this.pos.subtract(this.pos_previous).add(this.acc.scale(c*c)),this.pos_previous.set_to(e))}}]),b}(AbstractWorldElement),AbstractConstraint=function(a){function b(){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.breakable=!1,c.breaking_strain=2,c}return _inherits(b,a),_createClass(b,[{key:"has_broken",value:function has_broken(){return!1}}]),b}(AbstractWorldElement),DistanceConstraint=function(a){function b(c,d,e,f){_classCallCheck(this,b);var g=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return g.p1=c,g.p2=d,g.distance=e,g.stiffness=f,g.current_distance=g.p2.pos.distance_from(g.p1.pos),g}return _inherits(b,a),_createClass(b,[{key:"enforce",value:function enforce(c){var d,e,f,g,h,k;this.current_distance=this.p2.pos.distance_from(this.p1.pos),this.current_distance!==this.distance&&(e=this.current_distance-this.distance,d=1-Math.pow(1-this.stiffness,1/c),f=(this.current_distance-this.distance)*d,k=new Vector2(this.p2.pos.x-this.p1.pos.x,this.p2.pos.y-this.p1.pos.y).unit_vector(),this.p2.fixed&&!this.p1.fixed?this.p1.pos=this.p1.pos.add(k.scale(f)):this.p1.fixed&&!this.p2.fixed?this.p2.pos=this.p2.pos.add(k.scale(-f)):!this.p2.fixed&&!this.p1.fixed&&(g=f*this.p1.mass/(this.p1.mass+this.p2.mass),h=f*this.p2.mass/(this.p1.mass+this.p2.mass),this.p1.pos=this.p1.pos.add(k.scale(h)),this.p2.pos=this.p2.pos.add(k.scale(-g))))}},{key:"has_broken",value:function has_broken(){var c,d;return!!this.breakable&&((c=this.current_distance-this.distance,d=Math.abs(c)/this.distance,!!(d>this.breaking_strain))||void 0)}}]),b}(AbstractConstraint),ParticleContactConstraint=function(a){function b(c,d){_classCallCheck(this,b);var e=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,c,d,c.radius+d.radius,1));return e.lifetime=e.age,e.stiffness=0.9,e}return _inherits(b,a),_createClass(b,[{key:"enforce",value:function enforce(c){var d,e,f,g,h,k;this.current_distance=this.p2.pos.distance_from(this.p1.pos),this.current_distance<=this.distance&&(e=this.current_distance-this.distance,d=1-Math.pow(1-this.stiffness,1/c),f=(this.current_distance-this.distance)*d,k=new Vector2(this.p2.pos.x-this.p1.pos.x,this.p2.pos.y-this.p1.pos.y).unit_vector(),this.p2.fixed&&!this.p1.fixed?this.p1.pos=this.p1.pos.add(k.scale(f)):this.p1.fixed&&!this.p2.fixed?this.p2.pos=this.p2.pos.add(k.scale(-f)):!this.p2.fixed&&!this.p1.fixed&&(g=f*this.p1.mass/(this.p1.mass+this.p2.mass),h=f*this.p2.mass/(this.p1.mass+this.p2.mass),this.p1.pos=this.p1.pos.add(k.scale(h)),this.p2.pos=this.p2.pos.add(k.scale(-g))))}}]),b}(DistanceConstraint),PointConstraint=function(a){function b(c,d,e,f){_classCallCheck(this,b);var g=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return g.p1=c,g.stiffness=f,g.anchor=new Vector2(d,e),g}return _inherits(b,a),_createClass(b,[{key:"enforce",value:function enforce(c){var d,e,f,g;e=this.p1.pos.distance_from(this.anchor),0!==e&&(d=1-Math.pow(1-this.stiffness,1/c),f=e*d,g=new Vector2(this.p1.pos.x-this.anchor.x,this.p1.pos.y-this.anchor.y).unit_vector(),this.p1.pos=this.p1.pos.add(g.scale(-f)))}},{key:"has_broken",value:function has_broken(){var c=this.p1.pos.distance_from(this.anchor);if(0!==c){var d=Math.abs(c);if(this.breakable&&d>this.breaking_strain)return!0}}}]),b}(AbstractConstraint),ParticleEdgeContactConstraint=function(a){function b(c){_classCallCheck(this,b);var d=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,c,c.x,c.y,1));return d.lifetime=d.age,d}return _inherits(b,a),b}(PointConstraint),AngleConstraint=function(a){function b(c,d,e,f,g){_classCallCheck(this,b);var h=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return h.p_anchor=c,h.p1=d,h.p2=e,h.angle=f,h.stiffness=g,h}return _inherits(b,a),_createClass(b,[{key:"enforce",value:function enforce(){}}]),b}(AbstractConstraint),Collision=function a(b,c){_classCallCheck(this,a),this.b1=b,this.b2=c},SpatialHash=function(){function a(b){_classCallCheck(this,a),this.spatial_hash={},this.size=0,this.bin_size=b}return _createClass(a,[{key:"add_item",value:function add_item(b,c,d){var e=Math.floor(b/this.bin_size),f=Math.floor(c/this.bin_size),g=e+","+f;void 0==this.spatial_hash[g]&&(this.spatial_hash[g]=[],this.size++),this.spatial_hash[g].push(d)}},{key:"get_x_index",value:function get_x_index(b){return Math.floor(b/this.bin_size)}},{key:"get_y_index",value:function get_y_index(b){return Math.floor(b/this.bin_size)}},{key:"retrieve_key",value:function retrieve_key(b,c){var d=Math.floor(b/this.bin_size),e=Math.floor(c/this.bin_size);return get_x_index(b)+","+get_y_index(c)}},{key:"retrieve_items",value:function retrieve_items(b,c){var d=Math.floor(b/this.bin_size),e=Math.floor(c/this.bin_size),f=[];f.push(d+","+e),f.push(d-1+","+e),f.push(d+1+","+e),f.push(d+","+(e+1)),f.push(d+","+(e-1)),f.push(d+1+","+(e+1)),f.push(d-1+","+(e+1)),f.push(d+1+","+(e-1)),f.push(d-1+","+(e-1));for(var g=[],h=0;h<f.length;h++)void 0!==this.spatial_hash[f[h]]&&(g=g.concat(this.spatial_hash[f[h]]));return g}},{key:"remove_items_in_cell",value:function remove_items_in_cell(){this.size--}},{key:"remove_item",value:function remove_item(){this.size--}},{key:"clear",value:function clear(){this.spatial_hash={},this.size=0}},{key:"get_size",value:function get_size(){return this.size}}]),a}(),PhysicsWorld=function(){function a(b,c,d,e){_classCallCheck(this,a),this.width=b,this.height=c,this.time_step=d,this.particles=[],this.constraints=[],this.collisions=[],this.boundaries=[],this.time=0,this.steps=0,this.gravitational_field=new Vector2(0,-9.81),this.constraint_solver_iterations=e,this.particle_to_particle_attraction_active=!1,this.particle_attraction_coefficient=30,this.simple_world_boundary_collisions=!0,this.damping_coefficient=0,this.coeffieicnt_of_restitution=0.7,this.particle_to_particle_collisions=!0,this.SPH_smoothing_length=1,this.SPH_spatial_partitioning=!0,this.SPH_sh=new SpatialHash(this.SPH_smoothing_length),this.SPH_rest_density=1e3,this.SPH_k=10,this.SPH_u=1500,this.SPH_sigma_density=315/(64*PI*Math.pow(this.SPH_smoothing_length,9)),this.SPH_sigma_pressure=-45/(Math.PI*Math.pow(this.SPH_smoothing_length,6)),this.SPH_sigma_viscosity=45/(Math.PI*Math.pow(this.SPH_smoothing_length,6))}return _createClass(a,[{key:"create_particle",value:function create_particle(b,c,d,e,f,g,h,k,l,m,n){this.particles.push(new Particle(b,c,d,e,f,g,h,k,l,m,n))}},{key:"create_distance_constraint",value:function create_distance_constraint(b,c,d,e){null==d&&(d=c.pos.distance_from(b.pos)),null==e&&(e=0.9),this.constraints.push(new DistanceConstraint(b,c,d,e))}},{key:"create_point_constraint",value:function create_point_constraint(b,c,d,e){null==c&&(c=b.pos.x),null==d&&(d=b.pos.y),null==e&&(e=0.9),this.constraints.push(new PointConstraint(b,c,d,e))}},{key:"create_particle_contact_constraint",value:function create_particle_contact_constraint(b,c){this.constraints.push(new ParticleContactConstraint(b,c))}},{key:"delete_particle_by_index",value:function delete_particle_by_index(b){for(var c=this.particles[b],d=this.constraints.length,e=0;e<d;e++)this.constraints[e]instanceof DistanceConstraint?(this.constraints[e].p2===c||this.constraints[e].p1===c)&&(e==this.constraints.length-1?(this.delete_constraint_by_index(e),d--):(this.delete_constraint_by_index(e),d--,e--)):this.constraints[e]instanceof PointConstraint?this.constraints[e].p1===c&&(e==this.constraints.length-1?(this.delete_constraint_by_index(e),d--):(this.delete_constraint_by_index(e),d--,e--)):this.constraints[e]instanceof AngleConstraint&&(this.constraints[e].p1===c||this.constraints[e].p2===c||this.constraints[e].p_anchor===c)&&(e==this.constraints.length-1?(this.delete_constraint_by_index(e),d--):(this.delete_constraint_by_index(e),d--,e--));this.particles.splice(b,1)}},{key:"delete_particle_by_reference",value:function delete_particle_by_reference(b){var c=this.particles.indexOf(b);this.delete_particle_by_index(c)}},{key:"delete_constraint_by_index",value:function delete_constraint_by_index(b){this.constraints.splice(b,1)}},{key:"delete_constraint_by_reference",value:function delete_constraint_by_reference(b){var c=this.constraints.indexOf(b);this.delete_constraint_by_index(c)}},{key:"update",value:function update(){this.clean_up(),this.accumulate_forces(),this.collision_detection_and_response(),this.constraint_resolution(),this.integrate(),this.time+=this.time_step,++this.steps}},{key:"clean_up",value:function clean_up(){this.SPH_sh.clear(),this.collisions.length=0;for(var b=this.constraints.length,c=0;c<b;c++)++this.constraints[c].age,this.constraints[c].has_life_expired()&&(c==this.constraints.length-1?(this.delete_constraint_by_index(c),b--):(this.delete_constraint_by_index(c),b--,c--));b=this.particles.length;for(var d=0;d<b;d++)++this.particles[d].age,this.particles[d].has_life_expired()?d==this.particles.length-1?(this.delete_particle_by_index(d),b--):(this.delete_particle_by_index(d),b--,d--):(this.particles[d].force.set_to_zero(),this.particles[d].acc.set_to_zero(),this.particles[d].SPH_density=0,this.particles[d].SPH_neighbours=[])}},{key:"accumulate_forces",value:function accumulate_forces(){this.calculate_gravitational_field_forces(),this.calculate_attraction_field_forces(),this.calculate_fluid_forces()}},{key:"constraint_resolution",value:function constraint_resolution(){for(var b=0;b<this.constraint_solver_iterations;b++){for(var c=0;c<this.constraints.length;c++)this.constraints[c].enforce(this.constraint_solver_iterations);for(var d=0;d<this.particles.length;d++)this.simple_world_boundary_collisions&&(this.particles[d].pos.y+this.particles[d].radius>this.height?this.particles[d].pos.y=this.height-this.particles[d].radius:0>this.particles[d].pos.y-this.particles[d].radius&&(this.particles[d].pos.y=0+this.particles[d].radius),this.particles[d].pos.x+this.particles[d].radius>this.width?this.particles[d].pos.x=this.width-this.particles[d].radius:0>this.particles[d].pos.x-this.particles[d].radius&&(this.particles[d].pos.x=0+this.particles[d].radius))}for(var e=this.constraints.length,f=0;f<e;f++)this.constraints[f].has_broken()&&(f==this.constraints.length-1?(this.delete_constraint_by_index(f),e--):(this.delete_constraint_by_index(f),e--,f--))}},{key:"collision_detection_and_response",value:function collision_detection_and_response(){for(var b=0,c=0,d=0;d<this.particles.length;d++){if(this.particles[d].collides&&this.particle_to_particle_collisions){c=0;for(var e=0;e<this.particles.length;e++)c>b&&Math.pow(this.particles[b].pos.x-this.particles[c].pos.x,2)+Math.pow(this.particles[b].pos.y-this.particles[c].pos.y,2)<Math.pow(this.particles[b].radius+this.particles[c].radius,2)&&this.create_particle_contact_constraint(this.particles[b],this.particles[c]),c++}b++}}},{key:"calculate_gravitational_field_forces",value:function calculate_gravitational_field_forces(){for(var b=0;b<this.particles.length;b++)this.particles[b].acc=this.particles[b].acc.add(this.gravitational_field)}},{key:"calculate_attraction_field_forces",value:function calculate_attraction_field_forces(){if(this.particle_to_particle_attraction_active)for(var c,b=0;b<this.particles.length;b++){c=new Vector2(0,0);for(var d=0;d<this.particles.length;d++)if(d!=b){var e=this.particles[d].pos.subtract(this.particles[b].pos),f=e.unit_vector(),g=this.particle_attraction_coefficient*this.particles[b].attractive_strength*this.particles[d].attractive_strength/e.magnitude_squared();c=c.add(f.scale(g))}this.particles[b].acc=this.particles[b].acc.add(c.scale(1/this.particles[b].mass))}}},{key:"calculate_fluid_forces",value:function calculate_fluid_forces(){if(this.SPH_spatial_partitioning){for(var b=0;b<this.particles.length;b++)this.particles[b].SPH_particle&&this.SPH_sh.add_item(this.particles[b].pos.x,this.particles[b].pos.y,this.particles[b]);for(var d,c=0;c<this.particles.length;c++){d=this.SPH_sh.retrieve_items(this.particles[c].pos.x,this.particles[c].pos.y);for(var e=0;e<d.length;e++)if(!0==d[e].SPH_particle){var f=Math.pow(this.particles[c].pos.x-d[e].pos.x,2)+Math.pow(this.particles[c].pos.y-d[e].pos.y,2),g=Math.pow(this.SPH_smoothing_length,2);f<g&&this.particles[c].SPH_neighbours.push(d[e])}}}else for(var k=0,l=0;l<this.particles.length;l++)if(this.particles[l].SPH_neighbours=[],!0==this.particles[l].SPH_particle){k=0;for(var m=0;m<this.particles.length;m++){if(k>=0&&!0==this.particles[m].SPH_particle){var n=Math.pow(this.particles[l].pos.x-this.particles[m].pos.x,2)+Math.pow(this.particles[l].pos.y-this.particles[m].pos.y,2),o=Math.pow(this.SPH_smoothing_length,2);n<o&&this.particles[l].SPH_neighbours.push(this.particles[m])}k++}}for(var p=0;p<this.particles.length;p++)if(!0==this.particles[p].SPH_particle){if(0<this.particles[p].SPH_neighbours.length)for(var q=0;q<this.particles[p].SPH_neighbours.length;q++){var r=Math.pow(this.particles[p].pos.x-this.particles[p].SPH_neighbours[q].pos.x,2)+Math.pow(this.particles[p].pos.y-this.particles[p].SPH_neighbours[q].pos.y,2),s=this.SPH_smoothing_length*this.SPH_smoothing_length;if(r<s){var t=this.SPH_sigma_density*Math.pow(this.SPH_smoothing_length*this.SPH_smoothing_length-r,3);this.particles[p].SPH_density+=t*this.particles[p].SPH_neighbours[q].mass}}this.particles[p].SPH_density<this.SPH_rest_density&&(this.particles[p].SPH_density=this.SPH_rest_density),this.particles[p].SPH_pressure=this.SPH_k*(this.particles[p].SPH_density-this.SPH_rest_density)}for(var u=0;u<this.particles.length;u++)if(!0==this.particles[u].SPH_particle)for(var w=0;w<this.particles[u].SPH_neighbours.length;w++)if(this.particles[u]!==this.particles[u].SPH_neighbours[w]){var z=Math.pow(this.particles[u].pos.x-this.particles[u].SPH_neighbours[w].pos.x,2)+Math.pow(this.particles[u].pos.y-this.particles[u].SPH_neighbours[w].pos.y,2),A=this.SPH_smoothing_length*this.SPH_smoothing_length;if(z<A){var B=this.SPH_sigma_pressure*Math.pow(this.SPH_smoothing_length-Math.sqrt(z),2),C=this.particles[u].SPH_neighbours[w].pos.subtract(this.particles[u].pos).unit_vector(),D=this.particles[u].SPH_neighbours[w].mass*(this.particles[u].SPH_pressure+this.particles[u].SPH_neighbours[w].SPH_pressure)/(2*this.particles[u].SPH_neighbours[w].SPH_density)*B;this.particles[u].force=this.particles[u].force.add(C.scale(D));var E=this.SPH_sigma_viscosity*(this.SPH_smoothing_length-Math.sqrt(z)),F=this.particles[u].SPH_neighbours[w].vel.subtract(this.particles[u].vel),G=F.scale(this.particles[u].SPH_neighbours[w].mass/this.particles[u].SPH_neighbours[w].SPH_density*E);this.particles[u].force=this.particles[u].force.add(G.scale(this.SPH_u))}}}},{key:"integrate",value:function integrate(){for(var b=0;b<this.particles.length;b++)this.particles[b].integrate(this.time_step,this.damping_coefficient)}}]),a}();